#!/bin/bash
#
# Script to build transpiler Docker image.
#
# Needs root privileges or 'docker' group membership

SCRIPT_DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
. "${SCRIPT_DIR}/../inc.constants"
. "${SCRIPT_DIR}/../inc.functions"


# Default values
DEFAULT_ANDROID_API=28
DEFAULT_ANDROID_BUILD_TOOLS=28.0.3


# Functions
function usage {
    echo -e "Usage: ${0} [OPTIONS]"
    echo -e "Options:"
    echo -e "  --android-api API_LEVEL\t(default: ${DEFAULT_ANDROID_API})"
    echo -e "  --android-build-tools BUILD_TOOLS_VERSION\t(default: ${DEFAULT_ANDROID_BUILD_TOOLS})"
    exit 1
}


# Command-line arguments
android_api=${DEFAULT_ANDROID_API}
android_build_tools=${DEFAULT_ANDROID_BUILD_TOOLS}
while [[ $# -gt 0 ]] ; do
    key="$1"
    case $key in
    --android-api)
        android_api="$2"
        shift # past argument
        ;;
    --android-build-tools)
        android_build_tools="$2"
        shift # past argument
        ;;
    -h|--help)
        usage
        shift # past argument
        ;;
    *) # unknown option
        ;;
    esac
    shift # past argument or value
done


# Let's roll
image_tag=${android_api}_${android_build_tools}

safe docker build \
    --build-arg android_api=${android_api} \
    --build-arg android_build_tools=${android_build_tools} \
    -t ${DOCKER_IMAGE}:${image_tag} \
    .

if [ ${android_api} -eq ${DEFAULT_ANDROID_API} -a \
     ${android_build_tools} = ${DEFAULT_ANDROID_BUILD_TOOLS} ]; then
    safe docker tag \
        ${DOCKER_IMAGE}:${image_tag} \
        ${DOCKER_IMAGE}:latest
fi
